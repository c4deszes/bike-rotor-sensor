name: Hardware

on:
  pull_request:
    paths:
      - 'hardware/**'
      - '.github/workflows/hardware*.yml'

jobs:
  ERC:
    name: ERC
    runs-on: ubuntu-latest
    container: setsoft/kicad_auto
    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Run ERC
      working-directory: hardware
      run: ./scripts/run_erc.sh

  DRC:
    name: DRC
    needs: ERC
    runs-on: ubuntu-latest
    container: setsoft/kicad_auto
    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Run DRC
      working-directory: hardware
      run: ./scripts/run_drc.sh

  documentation:
    name: Export Documents
    needs: DRC
    runs-on: ubuntu-latest
    container: setsoft/kicad_auto
    strategy:
      matrix:
        variant:
          - OPTICAL
          - EXTERNAL
          - HALL
    env:
      VARIANT: ${{ matrix.variant }}
    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Generate schematic document
      working-directory: hardware
      run: ./scripts/export_schematic.sh

    - name: Generate layout document
      working-directory: hardware
      run: ./scripts/export_layout.sh

    - name: Generate step file
      working-directory: hardware
      run: ./scripts/export_step.sh

    - name: Archive Output
      uses: actions/upload-artifact@v2
      with:
        name: documentation-${{ matrix.variant }}
        path: hardware/build/
        if-no-files-found: error

  manufacturing:
    name: Export BOM & Gerbers
    needs: DRC
    runs-on: ubuntu-latest
    container: setsoft/kicad_auto
    strategy:
      matrix:
        variant:
          - OPTICAL
          - EXTERNAL
          - HALL
    env:
      VARIANT: ${{ matrix.variant }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Generate Gerbers
        working-directory: hardware
        run: ./scripts/export_gerbers.sh

      - name: Generate BOM
        working-directory: hardware
        run: ./scripts/export_bom.sh

      - name: Archive Output
        uses: actions/upload-artifact@v2
        with:
          name: manufacturing-${{ matrix.variant }}
          path: hardware/build/
          if-no-files-found: error

  panelize:
    name: Panelize
    needs: DRC
    runs-on: ubuntu-latest
    container: setsoft/kicad_auto
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Setup Kikit
        run: pip install kikit

      - name: Panelize
        working-directory: hardware
        run: kikit panelize grid --space 3 --gridsize 3 3 --tabwidth 3 --tabheight 3 --htabs 2 --vtabs 1 --mousebites 0.5 1 0.25 --radius 1 rotor-sensor.kicad_pcb rotor-sensor-panelized.kicad_pcb
